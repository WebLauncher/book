<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Associations: Linking Models Together" lang="en" name="title" />
<meta content="relationship types,relational mapping,recipe database,relational database,this section covers,web applications,recipes,models,WebLauncher Framework,storage" lang="en" name="keywords" />

    <title>Associations: Linking Models Together &mdash; WebLauncher Framework 2.7.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.1.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.1.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="WebLauncher Framework 2.7.0 documentation" href="../index.html" />
    <link rel="up" title="Models" href="../models.html" />
    <link rel="next" title="Retrieving Your Data" href="retrieving-your-data.html" />
    <link rel="prev" title="Models" href="../models.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><img src="../_static/logo.png">
          WebLauncher Framework</a>
        <span class="navbar-text navbar-version pull-left"><b>2.7</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../update.html">Update from 2.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configurations.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">Controllers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../views.html">Views</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Associations: Linking Models Together</a><ul>
<li><a class="reference internal" href="#relationship-types">Relationship Types</a></li>
<li><a class="reference internal" href="#hasone">hasOne</a></li>
<li><a class="reference internal" href="#belongsto">belongsTo</a><ul>
<li><a class="reference internal" href="#countercache-cache-your-count">counterCache - Cache your count()</a></li>
<li><a class="reference internal" href="#counterscope">counterScope</a></li>
<li><a class="reference internal" href="#multiple-countercache">Multiple counterCache</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hasmany">hasMany</a></li>
<li><a class="reference internal" href="#hasandbelongstomany-habtm">hasAndBelongsToMany (HABTM)</a></li>
<li><a class="reference internal" href="#hasmany-through-the-join-model">hasMany through (The Join Model)</a></li>
<li><a class="reference internal" href="#creating-and-destroying-associations-on-the-fly">Creating and Destroying Associations on the Fly</a></li>
<li><a class="reference internal" href="#multiple-relations-to-the-same-model">Multiple relations to the same model</a></li>
<li><a class="reference internal" href="#joining-tables">Joining tables</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../models.html" title="Previous Chapter: Models"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Models</span>
    </a>
  </li>
  <li>
    <a href="retrieving-your-data.html" title="Next Chapter: Retrieving Your Data"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Retrieving Your ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="https://github.com/weblauncher/book/edit/master/models/associations-linking-models-together.rst"
     rel="nofollow">Modify Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="associations-linking-models-together">
<h1>Associations: Linking Models Together<a class="headerlink" href="#associations-linking-models-together" title="Permalink to this headline">¶</a></h1>
<p>One of the most powerful features of WebLauncher Framework is the ability to link
relational mapping provided by the model. In WebLauncher Framework, the links
between models are handled through associations.</p>
<p>Defining relations between different objects in your application
should be a natural process. For example: in a recipe database, a
recipe may have many reviews, reviews have a single author, and
authors may have many recipes. Defining the way these relations
work allows you to access your data in an intuitive and powerful
way.</p>
<p>The purpose of this section is to show you how to plan for, define,
and utilize associations between models in WebLauncher Framework.</p>
<p>While data can come from a variety of sources, the most common form
of storage in web applications is a relational database. Most of
what this section covers will be in that context.</p>
<p>For information on associations with Plugin models, see
<em class="xref std std-ref">plugin-models</em>.</p>
<div class="section" id="relationship-types">
<h2>Relationship Types<a class="headerlink" href="#relationship-types" title="Permalink to this headline">¶</a></h2>
<p>The four association types in WebLauncher Framework are: hasOne, hasMany,
belongsTo, and hasAndBelongsToMany (HABTM).</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="26%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relationship</th>
<th class="head">Association Type</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>one to one</td>
<td>hasOne</td>
<td>A user has one profile.</td>
</tr>
<tr class="row-odd"><td>one to many</td>
<td>hasMany</td>
<td>A user can have multiple recipes.</td>
</tr>
<tr class="row-even"><td>many to one</td>
<td>belongsTo</td>
<td>Many recipes belong to a user.</td>
</tr>
<tr class="row-odd"><td>many to many</td>
<td>hasAndBelongsToMany</td>
<td>Recipes have, and belong to, many ingredients.</td>
</tr>
</tbody>
</table>
<p>Associations are defined by creating a class variable named after
the association you are defining. The class variable can sometimes
be as simple as a string, but can be as complex as a
multidimensional array used to define association specifics.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasOne = &#39;Profile&#39;;</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;Recipe&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Recipe&#39;,</span>
<span class="x">            &#39;conditions&#39; =&gt; array(&#39;Recipe.approved&#39; =&gt; &#39;1&#39;),</span>
<span class="x">            &#39;order&#39; =&gt; &#39;Recipe.created DESC&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>In the above example, the first instance of the word &#8216;Recipe&#8217; is
what is termed an &#8216;Alias&#8217;. This is an identifier for the
relationship, and can be anything you choose. Usually, you will
choose the same name as the class that it references. However,
<strong>aliases for each model must be unique across the app</strong>. For example, it is
appropriate to have:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;MyRecipe&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Recipe&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">    public $hasAndBelongsToMany = array(</span>
<span class="x">        &#39;MemberOf&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Group&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">class Group extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;MyRecipe&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Recipe&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">    public $hasAndBelongsToMany = array(</span>
<span class="x">        &#39;Member&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;User&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>but the following will not work well in all circumstances:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;MyRecipe&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Recipe&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">    public $hasAndBelongsToMany = array(</span>
<span class="x">        &#39;Member&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Group&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">class Group extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;MyRecipe&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Recipe&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">    public $hasAndBelongsToMany = array(</span>
<span class="x">        &#39;Member&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;User&#39;,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>because here we have the alias &#8216;Member&#8217; referring to both the User
(in Group) and the Group (in User) model in the HABTM associations.
Choosing non-unique names for model aliases across models can cause
unexpected behavior.</p>
<p>WebLauncher Framework will automatically create links between associated model
objects. So for example in your <tt class="docutils literal"><span class="pre">User</span></tt> model you can access the
<tt class="docutils literal"><span class="pre">Recipe</span></tt> model as:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$this-&gt;Recipe-&gt;someFunction();</span>
</pre></div>
</div>
<p>Similarly in your controller you can access an associated model
simply by following your model associations:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$this-&gt;User-&gt;Recipe-&gt;someFunction();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember that associations are defined &#8216;one way&#8217;. If you define
User hasMany Recipe, that has no effect on the Recipe Model. You
need to define Recipe belongsTo User to be able to access the User
model from your Recipe model.</p>
</div>
</div>
<div class="section" id="hasone">
<h2>hasOne<a class="headerlink" href="#hasone" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s set up a User model with a hasOne relationship to a Profile
model.</p>
<p>First, your database tables need to be keyed correctly. For a
hasOne relationship to work, one table has to contain a foreign key
that points to a record in the other. In this case, the profiles
table will contain a field called user_id. The basic pattern is:</p>
<p><strong>hasOne:</strong> the <em>other</em> model contains the foreign key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="53%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relation</th>
<th class="head">Schema</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Apple hasOne Banana</td>
<td>bananas.apple_id</td>
</tr>
<tr class="row-odd"><td>User hasOne Profile</td>
<td>profiles.user_id</td>
</tr>
<tr class="row-even"><td>Doctor hasOne Mentor</td>
<td>mentors.doctor_id</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not mandatory to follow WebLauncher Framework conventions. You can easily override
the use of any foreignKey in your associations definitions. Nevertheless, sticking
to conventions will make your code less repetitive and easier to read and maintain.</p>
</div>
<p>The User model file will be saved in /app/Model/User.php. To
define the &#8216;User hasOne Profile&#8217; association, add the $hasOne
property to the model class. Remember to have a Profile model in
/app/Model/Profile.php, or the association won&#8217;t work:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasOne = &#39;Profile&#39;;</span>
<span class="x">}</span>
</pre></div>
</div>
<p>There are two ways to describe this relationship in your model
files. The simplest method is to set the $hasOne attribute to a
string containing the class name of the associated model, as we&#8217;ve
done above.</p>
<p>If you need more control, you can define your associations using
array syntax. For example, you might want to limit the association
to include only certain records.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasOne = array(</span>
<span class="x">        &#39;Profile&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Profile&#39;,</span>
<span class="x">            &#39;conditions&#39; =&gt; array(&#39;Profile.published&#39; =&gt; &#39;1&#39;),</span>
<span class="x">            &#39;dependent&#39; =&gt; true</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Possible keys for hasOne association arrays include:</p>
<ul class="simple">
<li><strong>className</strong>: the class name of the model being associated to
the current model. If you&#8217;re defining a &#8216;User hasOne Profile&#8217;
relationship, the className key should equal &#8216;Profile&#8217;.</li>
<li><strong>foreignKey</strong>: the name of the foreign key found in the other
model. This is especially handy if you need to define multiple
hasOne relationships. The default value for this key is the
underscored, singular name of the current model, suffixed with
&#8216;_id&#8217;. In the example above, it would default to &#8216;user_id&#8217;.</li>
<li><strong>conditions</strong>: an array of find()-compatible conditions or SQL
strings such as array(&#8216;Profile.approved&#8217; =&gt; true)</li>
<li><strong>fields</strong>: A list of fields to be retrieved when the associated
model data is fetched. Returns all fields by default.</li>
<li><strong>order</strong>: an array of find()-compatible order clauses or SQL
strings such as array(&#8216;Profile.last_name&#8217; =&gt; &#8216;ASC&#8217;)</li>
<li><strong>dependent</strong>: When the dependent key is set to true, and the
model&#8217;s delete() method is called with the cascade parameter set to
true, associated model records are also deleted. In this case, we
set it true so that deleting a User will also delete her associated
Profile.</li>
</ul>
<p>Once this association has been defined, find operations on the User
model will also fetch a related Profile record if it exists:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">//Sample results from a $this-&gt;User-&gt;find() call.</span>

<span class="x">Array</span>
<span class="x">(</span>
<span class="x">    [User] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 121</span>
<span class="x">            [name] =&gt; Gwoo the Kungwoo</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">        )</span>
<span class="x">    [Profile] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 12</span>
<span class="x">            [user_id] =&gt; 121</span>
<span class="x">            [skill] =&gt; Baking Cakes</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">        )</span>
<span class="x">)</span>
</pre></div>
</div>
</div>
<div class="section" id="belongsto">
<h2>belongsTo<a class="headerlink" href="#belongsto" title="Permalink to this headline">¶</a></h2>
<p>Now that we have Profile data access from the User model, let&#8217;s
define a belongsTo association in the Profile model in order to get
access to related User data. The belongsTo association is a natural
complement to the hasOne and hasMany associations: it allows us to
see the data from the other direction.</p>
<p>When keying your database tables for a belongsTo relationship,
follow this convention:</p>
<p><strong>belongsTo:</strong> the <em>current</em> model contains the foreign key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relation</th>
<th class="head">Schema</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Banana belongsTo Apple</td>
<td>bananas.apple_id</td>
</tr>
<tr class="row-odd"><td>Profile belongsTo User</td>
<td>profiles.user_id</td>
</tr>
<tr class="row-even"><td>Mentor belongsTo Doctor</td>
<td>mentors.doctor_id</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If a model(table) contains a foreign key, it belongsTo the other
model(table).</p>
</div>
<p>We can define the belongsTo association in our Profile model at
/app/Model/Profile.php using the string syntax as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Profile extends AppModel {</span>
<span class="x">    public $belongsTo = &#39;User&#39;;</span>
<span class="x">}</span>
</pre></div>
</div>
<p>We can also define a more specific relationship using array
syntax:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Profile extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;User&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;User&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;user_id&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Possible keys for belongsTo association arrays include:</p>
<ul class="simple">
<li><strong>className</strong>: the class name of the model being associated to
the current model. If you&#8217;re defining a &#8216;Profile belongsTo User&#8217;
relationship, the className key should equal &#8216;User&#8217;.</li>
<li><strong>foreignKey</strong>: the name of the foreign key found in the current
model. This is especially handy if you need to define multiple
belongsTo relationships. The default value for this key is the
underscored, singular name of the other model, suffixed with
<tt class="docutils literal"><span class="pre">_id</span></tt>.</li>
<li><strong>conditions</strong>: an array of find() compatible conditions or SQL
strings such as <tt class="docutils literal"><span class="pre">array('User.active'</span> <span class="pre">=&gt;</span> <span class="pre">true)</span></tt></li>
<li><strong>type</strong>: the type of the join to use in the SQL query. The default
is &#8216;LEFT&#8217;, which may not fit your needs in all situations. The value
&#8216;INNER&#8217; may be helpful (when used with some conditions) when you want
everything from your main and associated models or nothing at all.</li>
<li><strong>fields</strong>: A list of fields to be retrieved when the associated
model data is fetched. Returns all fields by default.</li>
<li><strong>order</strong>: an array of find() compatible order clauses or SQL
strings such as <tt class="docutils literal"><span class="pre">array('User.username'</span> <span class="pre">=&gt;</span> <span class="pre">'ASC')</span></tt></li>
<li><strong>counterCache</strong>: If set to true, the associated Model will
automatically increase or decrease the
&#8220;[singular_model_name]_count&#8221; field in the foreign table
whenever you do a <tt class="docutils literal"><span class="pre">save()</span></tt> or <tt class="docutils literal"><span class="pre">delete()</span></tt>. If it&#8217;s a string, then it&#8217;s the
field name to use. The value in the counter field represents the
number of related rows. You can also specify multiple counter caches
by defining an array. See <a class="reference internal" href="#multiple-countercache"><em>Multiple counterCache</em></a>.</li>
<li><strong>counterScope</strong>: Optional conditions array to use for updating
counter cache field.</li>
</ul>
<p>Once this association has been defined, find operations on the
Profile model will also fetch a related User record if it exists:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">//Sample results from a $this-&gt;Profile-&gt;find() call.</span>

<span class="x">Array</span>
<span class="x">(</span>
<span class="x">   [Profile] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 12</span>
<span class="x">            [user_id] =&gt; 121</span>
<span class="x">            [skill] =&gt; Baking Cakes</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">        )</span>
<span class="x">    [User] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 121</span>
<span class="x">            [name] =&gt; Gwoo the Kungwoo</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">        )</span>
<span class="x">)</span>
</pre></div>
</div>
<div class="section" id="countercache-cache-your-count">
<h3>counterCache - Cache your count()<a class="headerlink" href="#countercache-cache-your-count" title="Permalink to this headline">¶</a></h3>
<p>This feature helps you cache the count of related data. Instead of
counting the records manually via <tt class="docutils literal"><span class="pre">find('count')</span></tt>, the model
itself tracks any addition/deletion towards the associated
<tt class="docutils literal"><span class="pre">$hasMany</span></tt> model and increases/decreases a dedicated integer
field within the parent model table.</p>
<p>The name of the field consists of the singular model name followed
by a underscore and the word &#8220;count&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">my_model_count</span>
</pre></div>
</div>
<p>Let&#8217;s say you have a model called <tt class="docutils literal"><span class="pre">ImageComment</span></tt> and a model
called <tt class="docutils literal"><span class="pre">Image</span></tt>. You would add a new INT-field to the <tt class="docutils literal"><span class="pre">images</span></tt>
table and name it <tt class="docutils literal"><span class="pre">image_comment_count</span></tt>.</p>
<p>Here are some more examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="31%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Model</th>
<th class="head">Associated Model</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>User</td>
<td>Image</td>
<td>users.image_count</td>
</tr>
<tr class="row-odd"><td>Image</td>
<td>ImageComment</td>
<td>images.image_comment_count</td>
</tr>
<tr class="row-even"><td>BlogEntry</td>
<td>BlogEntryComment</td>
<td>blog_entries.blog_entry_comment_count</td>
</tr>
</tbody>
</table>
<p>Once you have added the counter field, you are good to go. Activate
counter-cache in your association by adding a <tt class="docutils literal"><span class="pre">counterCache</span></tt> key
and set the value to <tt class="docutils literal"><span class="pre">true</span></tt>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class ImageComment extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;Image&#39; =&gt; array(</span>
<span class="x">            &#39;counterCache&#39; =&gt; true,</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>From now on, every time you add or remove a <tt class="docutils literal"><span class="pre">ImageComment</span></tt> associated to
<tt class="docutils literal"><span class="pre">Image</span></tt>, the number within <tt class="docutils literal"><span class="pre">image_comment_count</span></tt> is adjusted
automatically.</p>
</div>
<div class="section" id="counterscope">
<h3>counterScope<a class="headerlink" href="#counterscope" title="Permalink to this headline">¶</a></h3>
<p>You can also specify <tt class="docutils literal"><span class="pre">counterScope</span></tt>. It allows you to specify a
simple condition which tells the model when to update (or when not
to, depending on how you look at it) the counter value.</p>
<p>Using our Image model example, we can specify it like so:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class ImageComment extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;Image&#39; =&gt; array(</span>
<span class="x">            &#39;counterCache&#39; =&gt; &#39;active_comment_count&#39;, //custom field name</span>
<span class="x">            // only count if &quot;ImageComment&quot; is active = 1</span>
<span class="x">            &#39;counterScope&#39; =&gt; array(</span>
<span class="x">              &#39;ImageComment.active&#39; =&gt; 1</span>
<span class="x">            )</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-countercache">
<span id="id1"></span><h3>Multiple counterCache<a class="headerlink" href="#multiple-countercache" title="Permalink to this headline">¶</a></h3>
<p>Since 2.0, WebLauncher Framework has supported having multiple <tt class="docutils literal"><span class="pre">counterCache</span></tt> in a single model
relation. It is also possible to define a <tt class="docutils literal"><span class="pre">counterScope</span></tt> for each <tt class="docutils literal"><span class="pre">counterCache</span></tt>.
Assuming you have a <tt class="docutils literal"><span class="pre">User</span></tt> model and a <tt class="docutils literal"><span class="pre">Message</span></tt> model, and you want to be able
to count the amount of read and unread messages for each user.</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="30%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Model</th>
<th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>User</td>
<td>users.messages_read</td>
<td>Count read <tt class="docutils literal"><span class="pre">Message</span></tt></td>
</tr>
<tr class="row-odd"><td>User</td>
<td>users.messages_unread</td>
<td>Count unread <tt class="docutils literal"><span class="pre">Message</span></tt></td>
</tr>
<tr class="row-even"><td>Message</td>
<td>messages.is_read</td>
<td>Determines if a <tt class="docutils literal"><span class="pre">Message</span></tt> is read or not.</td>
</tr>
</tbody>
</table>
<p>With this setup, your <tt class="docutils literal"><span class="pre">belongsTo</span></tt> would look like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Message extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;User&#39; =&gt; array(</span>
<span class="x">            &#39;counterCache&#39; =&gt; array(</span>
<span class="x">                &#39;messages_read&#39; =&gt; array(&#39;Message.is_read&#39; =&gt; 1),</span>
<span class="x">                &#39;messages_unread&#39; =&gt; array(&#39;Message.is_read&#39; =&gt; 0)</span>
<span class="x">            )</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="hasmany">
<h2>hasMany<a class="headerlink" href="#hasmany" title="Permalink to this headline">¶</a></h2>
<p>Next step: defining a &#8220;User hasMany Comment&#8221; association. A hasMany
association will allow us to fetch a user&#8217;s comments when we fetch
a User record.</p>
<p>When keying your database tables for a hasMany relationship, follow
this convention:</p>
<p><strong>hasMany:</strong> the <em>other</em> model contains the foreign key.</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relation</th>
<th class="head">Schema</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>User hasMany Comment</td>
<td>Comment.user_id</td>
</tr>
<tr class="row-odd"><td>Cake hasMany Virtue</td>
<td>Virtue.cake_id</td>
</tr>
<tr class="row-even"><td>Product hasMany Option</td>
<td>Option.product_id</td>
</tr>
</tbody>
</table>
<p>We can define the hasMany association in our User model at
/app/Model/User.php using the string syntax as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasMany = &#39;Comment&#39;;</span>
<span class="x">}</span>
</pre></div>
</div>
<p>We can also define a more specific relationship using array
syntax:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;Comment&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Comment&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;user_id&#39;,</span>
<span class="x">            &#39;conditions&#39; =&gt; array(&#39;Comment.status&#39; =&gt; &#39;1&#39;),</span>
<span class="x">            &#39;order&#39; =&gt; &#39;Comment.created DESC&#39;,</span>
<span class="x">            &#39;limit&#39; =&gt; &#39;5&#39;,</span>
<span class="x">            &#39;dependent&#39; =&gt; true</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Possible keys for hasMany association arrays include:</p>
<ul class="simple">
<li><strong>className</strong>: the class name of the model being associated to
the current model. If you&#8217;re defining a &#8216;User hasMany Comment&#8217;
relationship, the className key should equal &#8216;Comment.&#8217;</li>
<li><strong>foreignKey</strong>: the name of the foreign key found in the other
model. This is especially handy if you need to define multiple
hasMany relationships. The default value for this key is the
underscored, singular name of the actual model, suffixed with
&#8216;_id&#8217;.</li>
<li><strong>conditions</strong>: an array of find() compatible conditions or SQL
strings such as array(&#8216;Comment.visible&#8217; =&gt; true)</li>
<li><strong>order</strong>:  an array of find() compatible order clauses or SQL
strings such as array(&#8216;Profile.last_name&#8217; =&gt; &#8216;ASC&#8217;)</li>
<li><strong>limit</strong>: The maximum number of associated rows you want
returned.</li>
<li><strong>offset</strong>: The number of associated rows to skip over (given
the current conditions and order) before fetching and associating.</li>
<li><strong>dependent</strong>: When dependent is set to true, recursive model
deletion is possible. In this example, Comment records will be
deleted when their associated User record has been deleted.</li>
<li><strong>exclusive</strong>: When exclusive is set to true, recursive model
deletion does the delete with a deleteAll() call, instead of
deleting each entity separately. This greatly improves performance,
but may not be ideal for all circumstances.</li>
<li><strong>finderQuery</strong>: A complete SQL query WebLauncher Framework can use to fetch
associated model records. This should be used in situations that
require highly customized results.
If a query you&#8217;re building requires a reference to the associated
model ID, use the special <tt class="docutils literal"><span class="pre">{$__cakeID__$}</span></tt> marker in the query.
For example, if your Apple model hasMany Orange, the query should
look something like this:
<tt class="docutils literal"><span class="pre">SELECT</span> <span class="pre">Orange.*</span> <span class="pre">from</span> <span class="pre">oranges</span> <span class="pre">as</span> <span class="pre">Orange</span> <span class="pre">WHERE</span> <span class="pre">Orange.apple_id</span> <span class="pre">=</span> <span class="pre">{$__cakeID__$};</span></tt></li>
</ul>
<p>Once this association has been defined, find operations on the User
model will also fetch related Comment records if they exist:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">//Sample results from a $this-&gt;User-&gt;find() call.</span>

<span class="x">Array</span>
<span class="x">(</span>
<span class="x">    [User] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 121</span>
<span class="x">            [name] =&gt; Gwoo the Kungwoo</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">        )</span>
<span class="x">    [Comment] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [0] =&gt; Array</span>
<span class="x">                (</span>
<span class="x">                    [id] =&gt; 123</span>
<span class="x">                    [user_id] =&gt; 121</span>
<span class="x">                    [title] =&gt; On Gwoo the Kungwoo</span>
<span class="x">                    [body] =&gt; The Kungwooness is not so Gwooish</span>
<span class="x">                    [created] =&gt; 2006-05-01 10:31:01</span>
<span class="x">                )</span>
<span class="x">            [1] =&gt; Array</span>
<span class="x">                (</span>
<span class="x">                    [id] =&gt; 124</span>
<span class="x">                    [user_id] =&gt; 121</span>
<span class="x">                    [title] =&gt; More on Gwoo</span>
<span class="x">                    [body] =&gt; But what of the &#39;Nut?</span>
<span class="x">                    [created] =&gt; 2006-05-01 10:41:01</span>
<span class="x">                )</span>
<span class="x">        )</span>
<span class="x">)</span>
</pre></div>
</div>
<p>One thing to remember is that you&#8217;ll need a complementary Comment
belongsTo User association in order to get the data from both
directions. What we&#8217;ve outlined in this section empowers you to get
Comment data from the User. Adding the Comment belongsTo User
association in the Comment model enables you to get User data from
the Comment model, completing the connection and allowing the flow
of information from either model&#8217;s perspective.</p>
</div>
<div class="section" id="hasandbelongstomany-habtm">
<h2>hasAndBelongsToMany (HABTM)<a class="headerlink" href="#hasandbelongstomany-habtm" title="Permalink to this headline">¶</a></h2>
<p>All right. At this point, you can already call yourself a WebLauncher Framework
model associations professional. You&#8217;re already well versed in the
three associations that take up the bulk of object relations.</p>
<p>Let&#8217;s tackle the final relationship type: hasAndBelongsToMany, or
HABTM. This association is used when you have two models that need
to be joined up, repeatedly, many times, in many different ways.</p>
<p>The main difference between hasMany and HABTM is that a link
between models in HABTM is not exclusive. For example, we&#8217;re about
to join up our Recipe model with an Ingredient model using HABTM.
Using tomatoes as an Ingredient for my grandma&#8217;s spaghetti recipe
doesn&#8217;t &#8220;use up&#8221; the ingredient. I can also use it for a salad Recipe.</p>
<p>Links between hasMany associated objects are exclusive. If my User
hasMany Comments, a comment is only linked to a specific user. It&#8217;s
not up for grabs.</p>
<p>Moving on. We&#8217;ll need to set up an extra table in the database to
handle HABTM associations. This new join table&#8217;s name needs to
include the names of both models involved, in alphabetical order,
and separated with an underscore ( _ ). The contents of the table
should be two fields that are foreign keys (which should be integers)
pointing to the primary keys of the involved models. To
avoid any issues, don&#8217;t define a combined primary key for these
two fields. If your application requires a unique index, you can define one.
If you plan to add any extra information to this table, or use
a &#8216;with&#8217; model, you should add an additional primary key field (by convention
&#8216;id&#8217;).</p>
<p><strong>HABTM</strong> requires a separate join table that includes both <em>model</em>
names.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relationship</th>
<th class="head">HABTM Table Fields</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Recipe HABTM Ingredient</td>
<td><strong>ingredients_recipes</strong>.id, <strong>ingredients_recipes</strong>.ingredient_id, <strong>ingredients_recipes</strong>.recipe_id</td>
</tr>
<tr class="row-odd"><td>Cake HABTM Fan</td>
<td><strong>cakes_fans</strong>.id, <strong>cakes_fans</strong>.cake_id, <strong>cakes_fans</strong>.fan_id</td>
</tr>
<tr class="row-even"><td>Foo HABTM Bar</td>
<td><strong>bars_foos</strong>.id, <strong>bars_foos</strong>.foo_id, <strong>bars_foos</strong>.bar_id</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Table names are in alphabetical order by convention. It is
possible to define a custom table name in association definition.</p>
</div>
<p>Make sure primary keys in tables <strong>cakes</strong> and <strong>recipes</strong> have
&#8220;id&#8221; fields as assumed by convention. If they&#8217;re different than
assumed, they must be changed in model&#8217;s <a class="reference internal" href="model-attributes.html#model-primarykey"><em>primaryKey</em></a>.</p>
<p>Once this new table has been created, we can define the HABTM
association in the model files. We&#8217;re going to skip straight to the
array syntax this time:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Recipe extends AppModel {</span>
<span class="x">    public $hasAndBelongsToMany = array(</span>
<span class="x">        &#39;Ingredient&#39; =&gt;</span>
<span class="x">            array(</span>
<span class="x">                &#39;className&#39; =&gt; &#39;Ingredient&#39;,</span>
<span class="x">                &#39;joinTable&#39; =&gt; &#39;ingredients_recipes&#39;,</span>
<span class="x">                &#39;foreignKey&#39; =&gt; &#39;recipe_id&#39;,</span>
<span class="x">                &#39;associationForeignKey&#39; =&gt; &#39;ingredient_id&#39;,</span>
<span class="x">                &#39;unique&#39; =&gt; true,</span>
<span class="x">                &#39;conditions&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;fields&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;order&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;limit&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;offset&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;finderQuery&#39; =&gt; &#39;&#39;,</span>
<span class="x">                &#39;with&#39; =&gt; &#39;&#39;</span>
<span class="x">            )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Possible keys for HABTM association arrays include:</p>
<ul id="ref-habtm-arrays">
<li><p class="first"><strong>className</strong>: the class name of the model being associated to
the current model. If you&#8217;re defining a &#8216;Recipe HABTM Ingredient&#8217;
relationship, the className key should equal &#8216;Ingredient&#8217;.</p>
</li>
<li><p class="first"><strong>joinTable</strong>: The name of the join table used in this
association (if the current table doesn&#8217;t adhere to the naming
convention for HABTM join tables).</p>
</li>
<li><p class="first"><strong>with</strong>: Defines the name of the model for the join table. By
default WebLauncher Framework will auto-create a model for you. Using the example
above it would be called IngredientsRecipe. By using this key you can
override this default name. The join table model can be used just
like any &#8220;regular&#8221; model to access the join table directly. By creating
a model class with such name and filename, you can add any custom behavior
to the join table searches, such as adding more information/columns to it.</p>
</li>
<li><p class="first"><strong>foreignKey</strong>: the name of the foreign key found in the current
model. This is especially handy if you need to define multiple
HABTM relationships. The default value for this key is the
underscored, singular name of the current model, suffixed with
&#8216;_id&#8217;.</p>
</li>
<li><p class="first"><strong>associationForeignKey</strong>: the name of the foreign key found in
the other model. This is especially handy if you need to define
multiple HABTM relationships. The default value for this key is the
underscored, singular name of the other model, suffixed with
&#8216;_id&#8217;.</p>
</li>
<li><dl class="first docutils">
<dt><strong>unique</strong>: boolean or string <tt class="docutils literal"><span class="pre">keepExisting</span></tt>.</dt>
<dd><ul class="first last simple">
<li>If true (default value) WebLauncher Framework will first delete existing relationship
records in the foreign keys table before inserting new ones.
Existing associations need to be passed again when updating.</li>
<li>When false, WebLauncher Framework will insert the specified new relationship records
and leave any existing relationship records in place, possibly
resulting in duplicate relationship records.</li>
<li>When set to <tt class="docutils literal"><span class="pre">keepExisting</span></tt>, the behavior is similar to <cite>true</cite>,
but with an additional check so that if any of the records
to be added are duplicates of an existing relationship record, the
existing relationship record is not deleted, and the duplicate
is ignored.  This can be useful if, for example, the join table
has additional data in it that needs to be retained.</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first"><strong>conditions</strong>: an array of find()-compatible conditions or SQL
string. If you have conditions on an associated table, you should use a
&#8216;with&#8217; model, and define the necessary belongsTo associations on it.</p>
</li>
<li><p class="first"><strong>fields</strong>: A list of fields to be retrieved when the associated
model data is fetched. Returns all fields by default.</p>
</li>
<li><p class="first"><strong>order</strong>: an array of find()-compatible order clauses or SQL
strings</p>
</li>
<li><p class="first"><strong>limit</strong>: The maximum number of associated rows you want
returned.</p>
</li>
<li><p class="first"><strong>offset</strong>: The number of associated rows to skip over (given
the current conditions and order) before fetching and associating.</p>
</li>
<li><p class="first"><strong>finderQuery</strong>: A complete SQL query WebLauncher Framework can use to fetch associated
model records. This should be used in situations that require
highly customized results.</p>
</li>
</ul>
<p>Once this association has been defined, find operations on the
Recipe model will also fetch related Tag records if they exist:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// Sample results from a $this-&gt;Recipe-&gt;find() call.</span>

<span class="x">Array</span>
<span class="x">(</span>
<span class="x">    [Recipe] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [id] =&gt; 2745</span>
<span class="x">            [name] =&gt; Chocolate Frosted Sugar Bombs</span>
<span class="x">            [created] =&gt; 2007-05-01 10:31:01</span>
<span class="x">            [user_id] =&gt; 2346</span>
<span class="x">        )</span>
<span class="x">    [Ingredient] =&gt; Array</span>
<span class="x">        (</span>
<span class="x">            [0] =&gt; Array</span>
<span class="x">                (</span>
<span class="x">                    [id] =&gt; 123</span>
<span class="x">                    [name] =&gt; Chocolate</span>
<span class="x">                )</span>
<span class="x">           [1] =&gt; Array</span>
<span class="x">                (</span>
<span class="x">                    [id] =&gt; 124</span>
<span class="x">                    [name] =&gt; Sugar</span>
<span class="x">                )</span>
<span class="x">           [2] =&gt; Array</span>
<span class="x">                (</span>
<span class="x">                    [id] =&gt; 125</span>
<span class="x">                    [name] =&gt; Bombs</span>
<span class="x">                )</span>
<span class="x">        )</span>
<span class="x">)</span>
</pre></div>
</div>
<p>Remember to define a HABTM association in the Ingredient model if you&#8217;d
like to fetch Recipe data when using the Ingredient model.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">HABTM data is treated like a complete set. Each time a new data association is added,
the complete set of associated rows in the database is dropped and created again so you
will always need to pass the whole data set for saving. For an alternative to using
HABTM, see <a class="reference internal" href="#hasmany-through"><em>hasMany through (The Join Model)</em></a>.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">For more information on saving HABTM objects, see <a class="reference internal" href="saving-your-data.html#saving-habtm"><em>Saving Related Model Data (HABTM)</em></a></p>
</div>
</div>
<div class="section" id="hasmany-through-the-join-model">
<span id="hasmany-through"></span><h2>hasMany through (The Join Model)<a class="headerlink" href="#hasmany-through-the-join-model" title="Permalink to this headline">¶</a></h2>
<p>It is sometimes desirable to store additional data with a many-to-many
association. Consider the following</p>
<p><cite>Student hasAndBelongsToMany Course</cite></p>
<p><cite>Course hasAndBelongsToMany Student</cite></p>
<p>In other words, a Student can take many Courses and a Course can be
taken by many Students. This is a simple many-to-many association
demanding a table such as this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">id | student_id | course_id</span>
</pre></div>
</div>
<p>Now what if we want to store the number of days that were attended
by the student on the course and their final grade? The table we&#8217;d
want would be:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">id | student_id | course_id | days_attended | grade</span>
</pre></div>
</div>
<p>The trouble is, hasAndBelongsToMany will not support this type of
scenario because when hasAndBelongsToMany associations are saved,
the association is deleted first. You would lose the extra data in
the columns as it is not replaced in the new insert.</p>
<blockquote>
<div><div class="versionchanged">
<p><span class="versionmodified">Changed in version 2.1.</span></p>
</div>
<p>You can set the <tt class="docutils literal"><span class="pre">unique</span></tt> setting to <tt class="docutils literal"><span class="pre">keepExisting</span></tt> to circumvent
losing extra data during the save operation. See <tt class="docutils literal"><span class="pre">unique</span></tt>
key in <a class="reference internal" href="#ref-habtm-arrays"><em>HABTM association arrays</em></a>.</p>
</div></blockquote>
<p>The way to implement our requirement is to use a <strong>join model</strong>,
otherwise known as a <strong>hasMany through</strong> association.
That is, the association is a model itself. So, we can create a new
model CourseMembership. Take a look at the following models.:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// Student.php</span>
<span class="x">class Student extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;CourseMembership&#39;</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">// Course.php</span>

<span class="x">class Course extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;CourseMembership&#39;</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">// CourseMembership.php</span>

<span class="x">class CourseMembership extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;Student&#39;, &#39;Course&#39;</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>The CourseMembership join model uniquely identifies a given
Student&#8217;s participation on a Course in addition to extra
meta-information.</p>
<p>Join models are pretty useful things to be able to use, and WebLauncher Framework
makes it easy to do so with its built-in hasMany and belongsTo
associations and saveAll feature.</p>
</div>
<div class="section" id="creating-and-destroying-associations-on-the-fly">
<span id="dynamic-associations"></span><h2>Creating and Destroying Associations on the Fly<a class="headerlink" href="#creating-and-destroying-associations-on-the-fly" title="Permalink to this headline">¶</a></h2>
<p>Sometimes it becomes necessary to create and destroy model
associations on the fly. This may be for any number of reasons:</p>
<ul class="simple">
<li>You want to reduce the amount of associated data fetched, but
all your associations are on the first level of recursion.</li>
<li>You want to change the way an association is defined in order to
sort or filter associated data.</li>
</ul>
<p>This association creation and destruction is done using the WebLauncher Framework
model bindModel() and unbindModel() methods. (There is also a very
helpful behavior called &#8220;Containable&#8221;. Please refer to the manual
section about Built-in behaviors for more information.) Let&#8217;s set
up a few models so we can see how bindModel() and unbindModel()
work. We&#8217;ll start with two models:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Leader extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;Follower&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Follower&#39;,</span>
<span class="x">            &#39;order&#39; =&gt; &#39;Follower.rank&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">class Follower extends AppModel {</span>
<span class="x">    public $name = &#39;Follower&#39;;</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Now, in the LeadersController, we can use the find() method in the
Leader model to fetch a Leader and its associated followers. As you
can see above, the association array in the Leader model defines a
&#8220;Leader hasMany Followers&#8221; relationship. For demonstration
purposes, let&#8217;s use unbindModel() to remove that association in a
controller action:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">public function some_action() {</span>
<span class="x">    // This fetches Leaders, and their associated Followers</span>
<span class="x">    $this-&gt;Leader-&gt;find(&#39;all&#39;);</span>

<span class="x">    // Let&#39;s remove the hasMany...</span>
<span class="x">    $this-&gt;Leader-&gt;unbindModel(</span>
<span class="x">        array(&#39;hasMany&#39; =&gt; array(&#39;Follower&#39;))</span>
<span class="x">    );</span>

<span class="x">    // Now using a find function will return</span>
<span class="x">    // Leaders, with no Followers</span>
<span class="x">    $this-&gt;Leader-&gt;find(&#39;all&#39;);</span>

<span class="x">    // NOTE: unbindModel only affects the very next</span>
<span class="x">    // find function. An additional find call will use</span>
<span class="x">    // the configured association information.</span>

<span class="x">    // We&#39;ve already used find(&#39;all&#39;) after unbindModel(),</span>
<span class="x">    // so this will fetch Leaders with associated</span>
<span class="x">    // Followers once again...</span>
<span class="x">    $this-&gt;Leader-&gt;find(&#39;all&#39;);</span>
<span class="x">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Removing or adding associations using bind- and unbindModel() only
works for the <em>next</em> find operation unless the second
parameter has been set to false. If the second parameter has been
set to <em>false</em>, the bind remains in place for the remainder of the
request.</p>
</div>
<p>Here&#8217;s the basic usage pattern for unbindModel():</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$this-&gt;Model-&gt;unbindModel(</span>
<span class="x">    array(&#39;associationType&#39; =&gt; array(&#39;associatedModelClassName&#39;))</span>
<span class="x">);</span>
</pre></div>
</div>
<p>Now that we&#8217;ve successfully removed an association on the fly,
let&#8217;s add one. Our as-of-yet unprincipled Leader needs some
associated Principles. The model file for our Principle model is
bare, except for the public $name statement. Let&#8217;s associate some
Principles to our Leader on the fly (but remember, only for the
following find operation). This function appears in the
LeadersController:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">public function another_action() {</span>
<span class="x">    // There is no Leader hasMany Principles in</span>
<span class="x">    // the leader.php model file, so a find here</span>
<span class="x">    // only fetches Leaders.</span>
<span class="x">    $this-&gt;Leader-&gt;find(&#39;all&#39;);</span>

<span class="x">    // Let&#39;s use bindModel() to add a new association</span>
<span class="x">    // to the Leader model:</span>
<span class="x">    $this-&gt;Leader-&gt;bindModel(</span>
<span class="x">        array(&#39;hasMany&#39; =&gt; array(</span>
<span class="x">                &#39;Principle&#39; =&gt; array(</span>
<span class="x">                    &#39;className&#39; =&gt; &#39;Principle&#39;</span>
<span class="x">                )</span>
<span class="x">            )</span>
<span class="x">        )</span>
<span class="x">    );</span>

<span class="x">    // Now that we&#39;re associated correctly,</span>
<span class="x">    // we can use a single find function to fetch</span>
<span class="x">    // Leaders with their associated principles:</span>
<span class="x">    $this-&gt;Leader-&gt;find(&#39;all&#39;);</span>
<span class="x">}</span>
</pre></div>
</div>
<p>There you have it. The basic usage for bindModel() is the
encapsulation of a normal association array inside an array whose
key is named after the type of association you are trying to
create:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$this-&gt;Model-&gt;bindModel(</span>
<span class="x">    array(&#39;associationName&#39; =&gt; array(</span>
<span class="x">            &#39;associatedModelClassName&#39; =&gt; array(</span>
<span class="x">                // normal association keys go here...</span>
<span class="x">            )</span>
<span class="x">        )</span>
<span class="x">    )</span>
<span class="x">);</span>
</pre></div>
</div>
<p>Even though the newly bound model doesn&#8217;t need any sort of
association definition in its model file, it will still need to be
correctly keyed in order for the new association to work properly.</p>
</div>
<div class="section" id="multiple-relations-to-the-same-model">
<h2>Multiple relations to the same model<a class="headerlink" href="#multiple-relations-to-the-same-model" title="Permalink to this headline">¶</a></h2>
<p>There are cases where a Model has more than one relation to another
Model. For example, you might have a Message model that has two
relations to the User model: one relation to the user who sends a
message, and a second to the user who receives the message. The
messages table will have a field user_id, but also a field
recipient_id. Now your Message model can look something like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Message extends AppModel {</span>
<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;Sender&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;User&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;user_id&#39;</span>
<span class="x">        ),</span>
<span class="x">        &#39;Recipient&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;User&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;recipient_id&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Recipient is an alias for the User model. Now let&#8217;s see what the
User model would look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class User extends AppModel {</span>
<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;MessageSent&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Message&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;user_id&#39;</span>
<span class="x">        ),</span>
<span class="x">        &#39;MessageReceived&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Message&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;recipient_id&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p>It is also possible to create self associations as shown below:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class Post extends AppModel {</span>

<span class="x">    public $belongsTo = array(</span>
<span class="x">        &#39;Parent&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Post&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;parent_id&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>

<span class="x">    public $hasMany = array(</span>
<span class="x">        &#39;Children&#39; =&gt; array(</span>
<span class="x">            &#39;className&#39; =&gt; &#39;Post&#39;,</span>
<span class="x">            &#39;foreignKey&#39; =&gt; &#39;parent_id&#39;</span>
<span class="x">        )</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
<p><strong>Fetching a nested array of associated records:</strong></p>
<p>If your table has a <tt class="docutils literal"><span class="pre">parent_id</span></tt> field, you can also use <a class="reference internal" href="retrieving-your-data.html#model-find-threaded"><em>find(&#8216;threaded&#8217;)</em></a>
to fetch a nested array of records using a single query without
setting up any associations.</p>
</div>
<div class="section" id="joining-tables">
<span id="id2"></span><h2>Joining tables<a class="headerlink" href="#joining-tables" title="Permalink to this headline">¶</a></h2>
<p>In SQL, you can combine related tables using the JOIN statement.
This allows you to perform complex searches across multiple tables
(for example, search posts given several tags).</p>
<p>In WebLauncher Framework, some associations (belongsTo and hasOne) perform
automatic joins to retrieve data, so you can issue queries to
retrieve models based on data in the related one.</p>
<p>But this is not the case with hasMany and hasAndBelongsToMany
associations. Here is where forcing joins comes to the rescue. You
only have to define the necessary joins to combine tables and get
the desired results for your query.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember that you need to set the recursion to -1 for this to work:
$this-&gt;Channel-&gt;recursive = -1;</p>
</div>
<p>To force a join between tables, you need to use the &#8220;modern&#8221; syntax
for Model::find(), adding a &#8216;joins&#8217; key to the $options array. For
example:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$options[&#39;joins&#39;] = array(</span>
<span class="x">    array(&#39;table&#39; =&gt; &#39;channels&#39;,</span>
<span class="x">        &#39;alias&#39; =&gt; &#39;Channel&#39;,</span>
<span class="x">        &#39;type&#39; =&gt; &#39;LEFT&#39;,</span>
<span class="x">        &#39;conditions&#39; =&gt; array(</span>
<span class="x">            &#39;Channel.id = Item.channel_id&#39;,</span>
<span class="x">        )</span>
<span class="x">    )</span>
<span class="x">);</span>

<span class="x">$Item-&gt;find(&#39;all&#39;, $options);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that the &#8216;join&#8217; arrays are not keyed.</p>
</div>
<p>In the above example, a model called Item is left-joined to the
channels table. You can alias the table with the Model name, so the
retrieved data complies with the WebLauncher Framework data structure.</p>
<p>The keys that define the join are the following:</p>
<ul class="simple">
<li><strong>table</strong>: The table for the join.</li>
<li><strong>alias</strong>: An alias to the table. The name of the model
associated with the table is the best bet.</li>
<li><strong>type</strong>: The type of join: inner, left or right.</li>
<li><strong>conditions</strong>: The conditions to perform the join.</li>
</ul>
<p>With joins, you could add conditions based on Related model
fields:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$options[&#39;joins&#39;] = array(</span>
<span class="x">    array(&#39;table&#39; =&gt; &#39;channels&#39;,</span>
<span class="x">        &#39;alias&#39; =&gt; &#39;Channel&#39;,</span>
<span class="x">        &#39;type&#39; =&gt; &#39;LEFT&#39;,</span>
<span class="x">        &#39;conditions&#39; =&gt; array(</span>
<span class="x">            &#39;Channel.id = Item.channel_id&#39;,</span>
<span class="x">        )</span>
<span class="x">    )</span>
<span class="x">);</span>

<span class="x">$options[&#39;conditions&#39;] = array(</span>
<span class="x">    &#39;Channel.private&#39; =&gt; 1</span>
<span class="x">);</span>

<span class="x">$privateItems = $Item-&gt;find(&#39;all&#39;, $options);</span>
</pre></div>
</div>
<p>You could perform several joins as needed in hasAndBelongsToMany:</p>
<p>Suppose there is a Book hasAndBelongsToMany Tag association. This relation
uses a books_tags table as a join table, so you need to join the
books table to the books_tags table, and this with the tags
table:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$options[&#39;joins&#39;] = array(</span>
<span class="x">    array(&#39;table&#39; =&gt; &#39;books_tags&#39;,</span>
<span class="x">        &#39;alias&#39; =&gt; &#39;BooksTag&#39;,</span>
<span class="x">        &#39;type&#39; =&gt; &#39;inner&#39;,</span>
<span class="x">        &#39;conditions&#39; =&gt; array(</span>
<span class="x">            &#39;Book.id = BooksTag.book_id&#39;</span>
<span class="x">        )</span>
<span class="x">    ),</span>
<span class="x">    array(&#39;table&#39; =&gt; &#39;tags&#39;,</span>
<span class="x">        &#39;alias&#39; =&gt; &#39;Tag&#39;,</span>
<span class="x">        &#39;type&#39; =&gt; &#39;inner&#39;,</span>
<span class="x">        &#39;conditions&#39; =&gt; array(</span>
<span class="x">            &#39;BooksTag.tag_id = Tag.id&#39;</span>
<span class="x">        )</span>
<span class="x">    )</span>
<span class="x">);</span>

<span class="x">$options[&#39;conditions&#39;] = array(</span>
<span class="x">    &#39;Tag.tag&#39; =&gt; &#39;Novel&#39;</span>
<span class="x">);</span>

<span class="x">$books = $Book-&gt;find(&#39;all&#39;, $options);</span>
</pre></div>
</div>
<p>Using joins allows you to have maximum flexibility in how WebLauncher Framework handles associations
and fetches the data. However, in most cases, you can use other tools to achieve the same results
such as correctly defining associations, binding models on the fly and using the Containable
behavior. This feature should be used with care because it could lead, in a few cases, into ill-formed
SQL queries if combined with any of the former techniques described for associating models.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, WebLauncher.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>